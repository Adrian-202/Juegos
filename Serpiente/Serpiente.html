<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Snake</title>

<style>
  body {
    background:white;
    font-family: Arial, Helvetica, sans-serif;
    padding:30px;
    display:flex;
    flex-direction:column;
    align-items:center;
    color:#222;
  }

  .game-wrapper {
    width:100%;
    display:flex;
    justify-content:center;
    gap:40px;
    margin-top:20px;
    align-items:flex-start;
  }

  #game {
    border:3px solid #dcdcdc;
    box-shadow:0 0 12px rgba(0,0,0,0.08);
  }

  .panel {
    width:200px;
    padding:15px 20px;
    border:2px solid #e5e5e5;
    border-radius:10px;
    background:#fafafa;
    box-shadow:0 2px 8px rgba(0,0,0,0.05);
  }

  h1 {
    font-size:26px;
    text-align:center;
    margin-bottom:10px;
  }

  #barra-estetica{
    margin-top:10px;
    font-size:20px;
    padding:10px 20px;
    background:#f3f3f3;
    border:2px solid #e8e8e8;
    border-radius:10px;
    box-shadow:0 2px 6px rgba(0,0,0,0.05);
  }

  .stat {
    font-size:18px;
    margin:8px 0;
  }

  button {
    width:100%;
    padding:12px;
    font-size:16px;
    margin-top:12px;
    border:none;
    background:#1a73e8;
    color:white;
    cursor:pointer;
    border-radius:6px;
  }
  button:hover { background:#155ec2; }

  #msg {
    text-align:center;
    margin-top:10px;
    color:#d00;
  }

  h3 {
    text-align:center;
    margin-top:20px;
  }
</style>
</head>

<body>

<h1>Snake</h1>

<div id="barra-estetica">
  Nivel: <b id="nivel_top">1</b> &nbsp;&nbsp;
  Puntuaci√≥n: <b id="puntos_top">0</b> &nbsp;&nbsp;
  Tama√±o: <b id="tam_top">5</b>
</div>

<div class="game-wrapper">
  
  <canvas id="game" width="480" height="480"></canvas>

  <div class="panel">
    <div class="stat">Nivel: <span id="nivel">1</span></div>
    <div class="stat">Puntuaci√≥n: <span id="puntos">0</span></div>
    <div class="stat">Tama√±o: <span id="tam">5</span></div>

    <button id="startBtn">Iniciar / Reanudar</button>
    <button id="resetBtn">Reiniciar</button>

    <div id="msg"></div>

    <h3>Top 5</h3>
    <ol id="top5"></ol>
  </div>

</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

const grid = 20;
const cols = canvas.width / grid;
const rows = canvas.height / grid;

let snake = [];
let dir = {dx:1, dy:0};
let desiredDir = {...dir};
let level = 1;
let points = 0;
let fps = 6;
let food = null;
let traps = [];
let initialSize = 5;
let running = false;
let lastTime = 0;
let frameAcc = 0;

const nivelEl = document.getElementById("nivel");
const puntosEl = document.getElementById("puntos");
const tamEl = document.getElementById("tam");

const nivelTop = document.getElementById("nivel_top");
const puntosTop = document.getElementById("puntos_top");
const tamTop = document.getElementById("tam_top");

function updateTopBar(){
  nivelTop.textContent = level;
  puntosTop.textContent = points;
  tamTop.textContent = snake.length;
}

function resetGame(){
  snake=[];
  for(let i=initialSize-1;i>=0;i--){
    snake.push({c:i,r:0});
  }
  dir={dx:1,dy:0};
  desiredDir={...dir};
  level=1;
  points=0;
  fps=6;
  spawnFood();
  spawnTraps();
  running=false;
  document.getElementById("msg").textContent="Presiona Iniciar";
  updatePanel();
  updateTopBar();
  renderTop5();
}

function updatePanel(){
  nivelEl.textContent=level;
  puntosEl.textContent=points;
  tamEl.textContent=snake.length;
  updateTopBar();
}

function cellInSnake(c,r){ return snake.some(s=>s.c===c && s.r===r); }
function foodIs(c,r){ return food && food.c===c && food.r===r; }
function trapIs(c,r){ return traps.some(t=>t.c===c && t.r===r); }

function randomFree(){
  while(true){
    const c=Math.floor(Math.random()*cols);
    const r=Math.floor(Math.random()*rows);
    if(!cellInSnake(c,r) && !foodIs(c,r) && !trapIs(c,r)) return {c,r};
  }
}

function spawnFood(){ food=randomFree(); }

/* ============================================================
     NUEVA FUNCI√ìN: minas que aumentan en cantidad con cada comida
==============================================================*/
function spawnTraps(){
  const extra = Math.floor(points / 10); // +1 mina por comida
  const total = 2 + extra;

  traps = [];
  for(let i = 0; i < total; i++){
    traps.push(randomFree());
  }
}

function saveScore(score){
  const top=JSON.parse(localStorage.getItem("snake_top5")||"[]");
  top.push(score);
  top.sort((a,b)=>b-a);
  localStorage.setItem("snake_top5",JSON.stringify(top.slice(0,5)));
  renderTop5();
}

function renderTop5(){
  const top=JSON.parse(localStorage.getItem("snake_top5")||"[]");
  document.getElementById("top5").innerHTML="";
  top.forEach(s=>{
    const li=document.createElement("li");
    li.textContent=s;
    document.getElementById("top5").appendChild(li);
  });
}

function gameOver(){
  running=false;
  document.getElementById("msg").textContent="Perdiste";
  saveScore(points);
}

function step(){
  if(!(desiredDir.dx===-dir.dx && desiredDir.dy===-dir.dy)){
    dir={...desiredDir};
  }

  const head={...snake[0]};
  const newH={c:head.c + dir.dx, r:head.r + dir.dy};

  // TRASPASAR PAREDES
  if(newH.c < 0) newH.c = cols - 1;
  else if(newH.c >= cols) newH.c = 0;

  if(newH.r < 0) newH.r = rows - 1;
  else if(newH.r >= rows) newH.r = 0;

  // COLISI√ìN CON S√ç MISMA
  if(cellInSnake(newH.c,newH.r)){
    gameOver(); 
    return;
  }

  snake.unshift(newH);

  /* ============================================================
        COMER COMIDA ‚Üí CAMBIAR Y AUMENTAR MINAS
  ============================================================*/
  if(foodIs(newH.c,newH.r)){
    points += 10;
    spawnFood();
    spawnTraps();   // üî• CAMBIO PEDIDO
  }
  else if(trapIs(newH.c,newH.r)){
    points=Math.max(0,points-5);
    snake.splice(-2,2);
    if(snake.length<1){ gameOver(); return; }
  }
  else snake.pop();

  // SUBIR DE NIVEL
  if (snake.length >= 15) {
      level++;
      fps++;

      while (snake.length > initialSize) {
          snake.pop();
      }

      spawnFood();
      spawnTraps();
  }

  updatePanel();
}

function drawGrid(){
  ctx.strokeStyle = "#eaeaea";
  for(let i=0;i<cols;i++){
    ctx.beginPath();
    ctx.moveTo(i*grid,0);
    ctx.lineTo(i*grid,canvas.height);
    ctx.stroke();
  }
  for(let j=0;j<rows;j++){
    ctx.beginPath();
    ctx.moveTo(0,j*grid);
    ctx.lineTo(canvas.width,j*grid);
    ctx.stroke();
  }
}

function drawSnake(){
  snake.forEach((s,i)=>{
    ctx.fillStyle = i===0 ? "#0077ff" : "#00aa00";
    ctx.fillRect(s.c*grid+1, s.r*grid+1, grid-2, grid-2);
  });
}

function draw(){
  ctx.fillStyle="white";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  drawGrid();

  ctx.fillStyle="#00cc00";
  ctx.fillRect(food.c*grid, food.r*grid, grid, grid);

  ctx.fillStyle="#cc0000";
  traps.forEach(t=>{
    ctx.fillRect(t.c*grid, t.r*grid, grid, grid);
  });

  drawSnake();
}

function loop(t){
  if(!lastTime) lastTime=t;
  const elapsed=t-lastTime;
  lastTime=t;

  frameAcc+=elapsed;

  if(running && frameAcc >= 1000/fps){
    frameAcc=0;
    step();
  }

  draw();
  requestAnimationFrame(loop);
}

document.addEventListener("keydown", e => {
    let key = e.key.toLowerCase();

    if (key === "arrowup" || key === "w") {
        if (dir.dy !== 1) desiredDir = { dx: 0, dy: -1 };
    }
    if (key === "arrowdown" || key === "s") {
        if (dir.dy !== -1) desiredDir = { dx: 0, dy: 1 };
    }
    if (key === "arrowleft" || key === "a") {
        if (dir.dx !== 1) desiredDir = { dx: -1, dy: 0 };
    }
    if (key === "arrowright" || key === "d") {
        if (dir.dx !== -1) desiredDir = { dx: 1, dy: 0 };
    }
});

document.getElementById("startBtn").addEventListener("click", ()=>{
  running=true;
  document.getElementById("msg").textContent="";
  lastTime=0;
});
document.getElementById("resetBtn").addEventListener("click", resetGame);

resetGame();
requestAnimationFrame(loop);
</script>

</body>
</html>
